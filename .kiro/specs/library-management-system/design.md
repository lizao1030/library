# 设计文档

## 概述

本文档描述图书馆管理系统的技术设计方案。系统采用前后端分离架构，前端使用 Vue 3 + Element Plus，后端使用 Python Flask，数据库使用 MySQL 8.0。

## 系统架构

```
┌─────────────────────────────────────────────────────────────┐
│                        前端 (Vue 3)                          │
│  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐           │
│  │ 登录页面 │ │ 图书管理 │ │ 借阅管理 │ │ 统计报表 │           │
│  └─────────┘ └─────────┘ └─────────┘ └─────────┘           │
└─────────────────────────────────────────────────────────────┘
                              │
                              │ HTTP/REST API
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                      后端 (Flask)                            │
│  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐           │
│  │ 用户服务 │ │ 图书服务 │ │ 借阅服务 │ │ 统计服务 │           │
│  └─────────┘ └─────────┘ └─────────┘ └─────────┘           │
└─────────────────────────────────────────────────────────────┘
                              │
                              │ SQLAlchemy ORM
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                     数据库 (MySQL 8.0)                       │
│  ┌─────────┐ ┌─────────┐ ┌─────────┐                       │
│  │  users  │ │  books  │ │ borrows │                       │
│  └─────────┘ └─────────┘ └─────────┘                       │
└─────────────────────────────────────────────────────────────┘
```

## 组件与接口

### 后端 API 接口设计

#### 用户模块

| 接口 | 方法 | 路径 | 功能 |
|------|------|------|------|
| 用户注册 | POST | /api/auth/register | 创建新用户账户 |
| 用户登录 | POST | /api/auth/login | 验证用户并返回token |
| 用户登出 | POST | /api/auth/logout | 销毁用户会话 |
| 获取用户列表 | GET | /api/users | 管理员获取所有用户 |
| 更新用户状态 | PUT | /api/users/{id} | 管理员禁用/启用用户 |

#### 图书模块

| 接口 | 方法 | 路径 | 功能 |
|------|------|------|------|
| 添加图书 | POST | /api/books | 管理员添加新图书 |
| 查询图书 | GET | /api/books | 搜索图书列表 |
| 获取图书详情 | GET | /api/books/{id} | 获取单本图书信息 |
| 更新图书 | PUT | /api/books/{id} | 管理员更新图书信息 |
| 删除图书 | DELETE | /api/books/{id} | 管理员删除图书 |

#### 借阅模块

| 接口 | 方法 | 路径 | 功能 |
|------|------|------|------|
| 借书 | POST | /api/borrows | 创建借阅记录 |
| 还书 | PUT | /api/borrows/{id}/return | 归还图书 |
| 借阅历史 | GET | /api/borrows | 查询借阅记录 |
| 借阅统计 | GET | /api/statistics/borrows | 获取借阅统计 |

### 请求/响应格式

#### 用户注册请求
```json
{
  "username": "string",
  "password": "string",
  "email": "string"
}
```

#### 借书请求
```json
{
  "user_id": "integer",
  "book_id": "integer"
}
```

#### 借书响应
```json
{
  "id": "integer",
  "user_id": "integer",
  "book_id": "integer",
  "borrow_date": "date",
  "due_date": "date",
  "status": "string"
}
```

## 数据模型

### 用户表 (users)

| 字段 | 类型 | 说明 |
|------|------|------|
| id | INT | 主键，自增 |
| username | VARCHAR(50) | 用户名，唯一 |
| password_hash | VARCHAR(255) | bcrypt加密的密码 |
| email | VARCHAR(100) | 邮箱，唯一 |
| role | ENUM('admin', 'reader') | 用户角色 |
| is_active | BOOLEAN | 账户是否启用 |
| created_at | DATETIME | 创建时间 |

### 图书表 (books)

| 字段 | 类型 | 说明 |
|------|------|------|
| id | INT | 主键，自增 |
| isbn | VARCHAR(20) | ISBN，唯一 |
| title | VARCHAR(200) | 书名 |
| author | VARCHAR(100) | 作者 |
| publisher | VARCHAR(100) | 出版社 |
| location | VARCHAR(50) | 馆藏位置 |
| total_stock | INT | 总库存 |
| available_stock | INT | 可借库存 |
| created_at | DATETIME | 创建时间 |

### 借阅记录表 (borrows)

| 字段 | 类型 | 说明 |
|------|------|------|
| id | INT | 主键，自增 |
| user_id | INT | 外键，关联users |
| book_id | INT | 外键，关联books |
| borrow_date | DATE | 借阅日期 |
| due_date | DATE | 应还日期 |
| return_date | DATE | 实际归还日期，可为空 |
| status | ENUM('borrowed', 'returned', 'overdue') | 借阅状态 |
| created_at | DATETIME | 创建时间 |

### ER 图

```
┌─────────────┐       ┌─────────────┐       ┌─────────────┐
│    users    │       │   borrows   │       │    books    │
├─────────────┤       ├─────────────┤       ├─────────────┤
│ id (PK)     │───┐   │ id (PK)     │   ┌───│ id (PK)     │
│ username    │   │   │ user_id (FK)│───┘   │ isbn        │
│ password    │   └───│ book_id (FK)│       │ title       │
│ email       │       │ borrow_date │       │ author      │
│ role        │       │ due_date    │       │ publisher   │
│ is_active   │       │ return_date │       │ location    │
│ created_at  │       │ status      │       │ total_stock │
└─────────────┘       │ created_at  │       │ avail_stock │
                      └─────────────┘       │ created_at  │
                                            └─────────────┘
```

## 正确性属性

正确性属性是系统在所有有效执行中都应保持为真的特征或行为。属性作为人类可读规范和机器可验证正确性保证之间的桥梁。

### 属性 1: 借阅归还往返一致性

**对于任意**图书和读者，借阅一本图书然后归还，图书的可用库存应恢复到借阅前的值。

**验证需求: 5.1, 6.1**

### 属性 2: 密码加密存储

**对于任意**用户注册，存储在数据库中的密码哈希值应为有效的bcrypt格式，且原始密码不应出现在数据库中。

**验证需求: 1.4**

### 属性 3: 库存非负约束

**对于任意**借阅操作，图书的可用库存永远不应变为负数。

**验证需求: 5.2**

### 属性 4: 逾期天数计算正确性

**对于任意**逾期归还的借阅记录，逾期天数应等于实际归还日期减去应还日期的天数差。

**验证需求: 6.3**

### 属性 5: 借阅期限设置

**对于任意**新创建的借阅记录，应还日期应等于借阅日期加30天。

**验证需求: 5.4, 5.5**

### 属性 6: 搜索结果相关性

**对于任意**图书搜索，返回的所有图书都应包含搜索关键词（在书名、作者或ISBN中）。

**验证需求: 4.1, 4.2**

### 属性 7: 用户名唯一性

**对于任意**两个不同的用户，他们的用户名应不相同。

**验证需求: 1.2**

### 属性 8: 逾期用户借阅限制

**对于任意**有逾期未还图书的读者，系统应拒绝其新的借阅请求。

**验证需求: 5.3**

## 错误处理

### HTTP 状态码

| 状态码 | 含义 | 使用场景 |
|--------|------|----------|
| 200 | 成功 | 请求成功处理 |
| 201 | 已创建 | 资源创建成功 |
| 400 | 错误请求 | 参数验证失败 |
| 401 | 未授权 | 未登录或token无效 |
| 403 | 禁止访问 | 权限不足 |
| 404 | 未找到 | 资源不存在 |
| 409 | 冲突 | 资源已存在（如用户名重复） |
| 500 | 服务器错误 | 内部错误 |

### 错误响应格式

```json
{
  "error": {
    "code": "ERROR_CODE",
    "message": "错误描述信息"
  }
}
```

### 常见错误码

| 错误码 | 描述 |
|--------|------|
| USER_EXISTS | 用户名已存在 |
| INVALID_CREDENTIALS | 用户名或密码错误 |
| BOOK_NOT_FOUND | 图书不存在 |
| OUT_OF_STOCK | 库存不足 |
| HAS_OVERDUE | 有逾期未还图书 |
| INVALID_ISBN | ISBN格式无效 |

## 测试策略

### 单元测试

使用 pytest 进行单元测试，覆盖率目标 ≥75%。

测试重点：
- 用户服务：注册、登录、密码加密
- 图书服务：入库、查询、库存管理
- 借阅服务：借书、还书、逾期计算

### 属性测试

使用 Hypothesis 库进行属性测试，每个属性测试运行至少100次迭代。

测试属性：
- 借阅归还往返一致性
- 密码加密存储
- 库存非负约束
- 逾期天数计算正确性
- 借阅期限设置

### 接口测试

使用 Postman 或 pytest 进行 API 接口测试，覆盖所有核心业务流程。

### 测试用例示例

| 用例ID | 场景 | 输入 | 预期输出 |
|--------|------|------|----------|
| TC-001 | 库存为0时借书 | book_id=1001, stock=0 | 返回"库存不足" |
| TC-002 | 正常借书 | book_id=1002, stock>0 | 返回借阅记录 |
| TC-003 | 逾期用户借书 | user有逾期记录 | 返回"有逾期未还图书" |
| TC-004 | 正常还书 | borrow_id=1 | 状态更新为"已归还" |
| TC-005 | 逾期还书 | 归还日期>应还日期 | 状态更新为"逾期归还" |
