# 图书馆管理系统测试报告

## 1. 测试概述

| 项目 | 内容 |
|------|------|
| 项目名称 | 图书馆管理系统 |
| 测试日期 | 2025年12月28日 |
| 测试环境 | Windows / Python 3.11+ / Flask 3.0 / SQLAlchemy 2.0 |
| 测试框架 | pytest + hypothesis |
| 测试执行时间 | 约 7 分钟 (437.01 秒) |

## 2. 测试结果摘要

| 指标 | 数值 |
|------|------|
| 总测试用例数 | 43 |
| 通过 | 43 |
| 失败 | 0 |
| 跳过 | 0 |
| 错误 | 0 |
| 通过率 | **100%** |
| 警告数 | 17 |

## 3. 测试分类统计

### 3.1 按测试类型分类

| 测试类型 | 用例数 | 通过 | 失败 | 说明 |
|----------|--------|------|------|------|
| 单元测试 | 9 | 9 | 0 | 用户API、配置测试 |
| 集成测试 | 15 | 15 | 0 | 前后端API集成测试 |
| 属性测试 | 19 | 19 | 0 | 基于Hypothesis的属性测试 |

### 3.2 按功能模块分类

| 模块 | 用例数 | 通过 | 失败 | 覆盖功能 |
|------|--------|------|------|----------|
| 用户认证 | 7 | 7 | 0 | 注册、登录、密码加密 |
| 图书管理 | 9 | 9 | 0 | CRUD、搜索、ISBN验证 |
| 借阅管理 | 14 | 14 | 0 | 借阅、归还、逾期检测 |
| 统计模块 | 4 | 4 | 0 | 统计查询、数据导出 |
| 权限控制 | 6 | 6 | 0 | 角色权限、访问控制 |
| 配置测试 | 3 | 3 | 0 | 环境配置、数据库连接 |

## 4. 详细测试用例清单

### 4.1 用户认证模块

| 测试用例 | 执行时间 | 状态 | 描述 |
|----------|----------|------|------|
| test_register_success | 0.204s | ✅ 通过 | 正常用户注册 |
| test_register_duplicate_username | 0.207s | ✅ 通过 | 重复用户名注册拒绝 |
| test_register_invalid_email | 0.008s | ✅ 通过 | 无效邮箱格式验证 |
| test_login_success | 0.407s | ✅ 通过 | 正常用户登录 |
| test_login_wrong_password | 0.400s | ✅ 通过 | 错误密码登录拒绝 |
| test_login_disabled_account | 0.389s | ✅ 通过 | 禁用账户登录拒绝 |
| test_full_auth_flow | 0.400s | ✅ 通过 | 完整认证流程测试 |

### 4.2 图书管理模块

| 测试用例 | 执行时间 | 状态 | 描述 |
|----------|----------|------|------|
| test_book_crud_flow | 0.403s | ✅ 通过 | 图书CRUD完整流程 |
| test_book_search | 0.399s | ✅ 通过 | 图书搜索功能 |
| test_duplicate_isbn_updates_stock | 0.397s | ✅ 通过 | 重复ISBN更新库存 |
| test_search_by_title_returns_relevant_books | 1.132s | ✅ 通过 | 按书名搜索相关性 |
| test_search_by_author_returns_relevant_books | 1.090s | ✅ 通过 | 按作者搜索相关性 |
| test_search_by_isbn_returns_relevant_books | 1.345s | ✅ 通过 | 按ISBN搜索相关性 |
| test_keyword_search_returns_relevant_books | 1.421s | ✅ 通过 | 关键词搜索相关性 |
| test_valid_isbn13_accepted | 0.069s | ✅ 通过 | 有效ISBN-13验证 |
| test_invalid_length_isbn_rejected | 0.053s | ✅ 通过 | 无效长度ISBN拒绝 |

### 4.3 借阅管理模块

| 测试用例 | 执行时间 | 状态 | 描述 |
|----------|----------|------|------|
| test_borrow_return_flow | 0.788s | ✅ 通过 | 借阅归还完整流程 |
| test_out_of_stock_borrow | 0.786s | ✅ 通过 | 库存不足借阅拒绝 |
| test_stock_never_negative_after_borrows | 27.786s | ✅ 通过 | 库存非负约束验证 |
| test_due_date_equals_borrow_date_plus_30_days | 25.076s | ✅ 通过 | 借阅期限30天验证 |
| test_calculate_due_date_function | 0.061s | ✅ 通过 | 到期日计算函数验证 |
| test_user_with_overdue_cannot_borrow | 25.665s | ✅ 通过 | 逾期用户借阅限制 |
| test_user_without_overdue_can_borrow | 24.807s | ✅ 通过 | 正常用户可借阅 |
| test_stock_restored_after_borrow_and_return | 25.091s | ✅ 通过 | 借还后库存恢复 |
| test_multiple_borrows_and_returns_restore_stock | 120.644s | ✅ 通过 | 多次借还库存恢复 |
| test_overdue_days_equals_return_date_minus_due_date | 20.497s | ✅ 通过 | 逾期天数计算正确性 |
| test_no_overdue_when_returned_before_due_date | 20.513s | ✅ 通过 | 提前归还无逾期 |
| test_overdue_days_zero_when_returned_on_due_date | 20.536s | ✅ 通过 | 当天归还无逾期 |

### 4.4 用户管理模块

| 测试用例 | 执行时间 | 状态 | 描述 |
|----------|----------|------|------|
| test_user_list_and_update | 0.777s | ✅ 通过 | 用户列表和更新 |
| test_role_change | 0.596s | ✅ 通过 | 用户角色更改 |
| test_password_stored_as_valid_bcrypt_hash | 37.611s | ✅ 通过 | 密码bcrypt加密存储 |
| test_wrong_password_rejected | 36.590s | ✅ 通过 | 错误密码验证拒绝 |
| test_duplicate_username_rejected | 37.751s | ✅ 通过 | 重复用户名拒绝 |

### 4.5 统计模块

| 测试用例 | 执行时间 | 状态 | 描述 |
|----------|----------|------|------|
| test_borrow_statistics | 0.412s | ✅ 通过 | 借阅统计查询 |
| test_user_statistics | 0.402s | ✅ 通过 | 用户统计查询 |
| test_export_borrows | 0.392s | ✅ 通过 | 借阅数据CSV导出 |
| test_export_users | 0.403s | ✅ 通过 | 用户数据CSV导出 |

### 4.6 权限控制模块

| 测试用例 | 执行时间 | 状态 | 描述 |
|----------|----------|------|------|
| test_reader_cannot_add_book | 0.402s | ✅ 通过 | 读者无法添加图书 |
| test_reader_cannot_view_statistics | 0.394s | ✅ 通过 | 读者无法查看统计 |
| test_unauthenticated_cannot_borrow | 0.397s | ✅ 通过 | 未认证用户无法借书 |

### 4.7 配置测试

| 测试用例 | 执行时间 | 状态 | 描述 |
|----------|----------|------|------|
| test_testing_config | 0.005s | ✅ 通过 | 测试环境配置验证 |
| test_development_config | 0.042s | ✅ 通过 | 开发环境配置验证 |
| test_database_connection | 0.009s | ✅ 通过 | 数据库连接验证 |

## 5. 属性测试 (Property-Based Testing) 详情

属性测试使用 Hypothesis 框架，每个测试用例自动生成 100 个随机测试样本。

### 5.1 已验证的系统属性

| 属性编号 | 属性名称 | 验证需求 | 测试样本数 | 状态 |
|----------|----------|----------|------------|------|
| Property 1 | 借阅归还往返一致性 | 5.1, 6.1 | 200 | ✅ 通过 |
| Property 2 | 密码加密存储 | 1.4 | 200 | ✅ 通过 |
| Property 3 | 库存非负约束 | 5.2 | 100 | ✅ 通过 |
| Property 4 | 逾期天数计算正确性 | 6.3 | 300 | ✅ 通过 |
| Property 5 | 借阅期限设置 | 5.4, 5.5 | 200 | ✅ 通过 |
| Property 6 | 搜索结果相关性 | 4.1, 4.2 | 400 | ✅ 通过 |
| Property 7 | 用户名唯一性 | 1.2 | 100 | ✅ 通过 |
| Property 8 | 逾期用户借阅限制 | 5.3 | 200 | ✅ 通过 |

### 5.2 属性测试统计

| 测试类 | 测试方法 | 通过样本 | 失败样本 | 无效样本 | 典型运行时间 |
|--------|----------|----------|----------|----------|--------------|
| TestSearchRelevanceProperty | test_search_by_title | 100 | 0 | 0 | 7-10ms |
| TestSearchRelevanceProperty | test_search_by_author | 100 | 0 | 0 | 7-13ms |
| TestSearchRelevanceProperty | test_search_by_isbn | 100 | 0 | 0 | 9-15ms |
| TestSearchRelevanceProperty | test_keyword_search | 100 | 0 | 0 | 9-16ms |
| TestISBNValidationProperty | test_valid_isbn13 | 100 | 0 | 0 | <1ms |
| TestISBNValidationProperty | test_invalid_length | 100 | 0 | 0 | <1ms |
| TestStockNonNegativeProperty | test_stock_never_negative | 100 | 0 | 0 | 251-312ms |
| TestBorrowDueDateProperty | test_due_date_30_days | 100 | 0 | 0 | 239-259ms |
| TestBorrowDueDateProperty | test_calculate_due_date | 100 | 0 | 0 | <1ms |
| TestOverdueUserBorrowRestrictionProperty | test_overdue_cannot_borrow | 100 | 0 | 137 | 0-262ms |
| TestOverdueUserBorrowRestrictionProperty | test_no_overdue_can_borrow | 100 | 0 | 0 | 237-257ms |
| TestBorrowReturnRoundTripProperty | test_stock_restored | 100 | 0 | 0 | 242-256ms |
| TestBorrowReturnRoundTripProperty | test_multiple_borrows_returns | 100 | 0 | 0 | 204-2409ms |
| TestOverdueDaysCalculationProperty | test_overdue_days_calculation | 100 | 0 | 0 | 197-209ms |
| TestOverdueDaysCalculationProperty | test_no_overdue_early_return | 100 | 0 | 0 | 197-208ms |
| TestOverdueDaysCalculationProperty | test_zero_overdue_on_due_date | 100 | 0 | 0 | 196-207ms |
| TestPasswordEncryptionProperty | test_bcrypt_hash | 100 | 0 | 0 | 360-384ms |
| TestPasswordEncryptionProperty | test_wrong_password | 100 | 0 | 176 | 0-365ms |
| TestUsernameUniquenessProperty | test_duplicate_username | 100 | 0 | 15 | 1-379ms |

## 6. 警告信息

测试过程中产生了 17 个 SQLAlchemy 弃用警告，均为 `LegacyAPIWarning`：

| 警告类型 | 涉及文件 | 说明 |
|----------|----------|------|
| Query.get() 弃用 | books.py:188, 224, 290 | 建议使用 Session.get() |
| Query.get() 弃用 | borrows.py:79, 90, 204, 230 | 建议使用 Session.get() |
| Query.get() 弃用 | users.py:100 | 建议使用 Session.get() |

**建议**: 将 `Model.query.get(id)` 替换为 `db.session.get(Model, id)` 以兼容 SQLAlchemy 2.0。

## 7. 需求覆盖矩阵

| 需求编号 | 需求描述 | 测试覆盖 | 状态 |
|----------|----------|----------|------|
| 1.2 | 用户名唯一性 | test_duplicate_username_rejected | ✅ |
| 1.4 | 密码加密存储 | test_password_stored_as_valid_bcrypt_hash | ✅ |
| 4.1 | 图书搜索-书名 | test_search_by_title_returns_relevant_books | ✅ |
| 4.2 | 图书搜索-作者/ISBN | test_search_by_author/isbn_returns_relevant_books | ✅ |
| 5.1 | 借阅功能 | test_borrow_return_flow | ✅ |
| 5.2 | 库存非负约束 | test_stock_never_negative_after_borrows | ✅ |
| 5.3 | 逾期用户限制 | test_user_with_overdue_cannot_borrow | ✅ |
| 5.4 | 借阅期限设置 | test_due_date_equals_borrow_date_plus_30_days | ✅ |
| 5.5 | 借阅记录 | test_calculate_due_date_function | ✅ |
| 6.1 | 归还功能 | test_stock_restored_after_borrow_and_return | ✅ |
| 6.3 | 逾期天数计算 | test_overdue_days_equals_return_date_minus_due_date | ✅ |

## 8. 测试结论

### 8.1 总体评估

本次测试全面覆盖了图书馆管理系统的核心功能模块，包括用户认证、图书管理、借阅管理、统计报表和权限控制。所有 43 个测试用例均通过，系统功能符合设计要求。

### 8.2 测试亮点

1. **属性测试覆盖**: 使用 Hypothesis 框架进行属性测试，每个属性测试自动生成 100 个随机样本，有效验证了系统在各种边界条件下的正确性。

2. **集成测试完整**: 集成测试覆盖了完整的业务流程，包括认证流程、图书CRUD、借阅归还流程等。

3. **权限控制验证**: 测试验证了角色权限控制的正确性，确保读者无法执行管理员操作。

### 8.3 改进建议

1. **SQLAlchemy API 升级**: 建议将 `Query.get()` 方法替换为 `Session.get()`，以消除弃用警告并兼容 SQLAlchemy 2.0。

2. **测试性能优化**: 部分属性测试执行时间较长（如 `test_multiple_borrows_and_returns_restore_stock` 耗时 120 秒），可考虑优化测试数据生成策略。

3. **增加边界测试**: 可增加更多边界条件测试，如超大库存、极端日期等场景。

---

**报告生成时间**: 2025年12月28日  
**测试执行人**: 自动化测试系统  
**测试工具**: pytest 8.x + hypothesis
